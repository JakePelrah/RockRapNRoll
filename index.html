<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/main.css">
</head>

<body>
    <div id="game-wrapper" class="wrapper no-select">

        <div id="main-menu">
            <!-- generate available genres here -->
        </div>

        <div id="game-board" style="display:none;">
            <div id="songs">
                <div class="gameControlElement" id="song_1" data-sample-id=""></div>
                <div class="gameControlElement" id="song_2" data-sample-id=""></div>
                <div class="gameControlElement" id="song_3" data-sample-id=""></div>
                <div class="gameControlElement" id="song_4" data-sample-id=""></div>
                <div class="gameControlElement" id="song_5" data-sample-id=""></div>
                <div class="gameControlElement" id="song_6" data-sample-id=""></div>
                <div class="gameControlElement" id="song_7" data-sample-id=""></div>
                <div class="gameControlElement" id="song_8" data-sample-id=""></div>
                <div class="gameControlElement" id="song_9" data-sample-id=""></div>
                <div class="gameControlElement" id="song_10" data-sample-id=""></div>
            </div>

            <div id="slots"></div>

            <div id="song-names">
                <img class="song gameControlElement" id="song_title_1.png" tabindex="-1" data-sample-id="">
                <img class="song gameControlElement" id="song_title_2.png" tabindex="-1" data-sample-id="">
                <img class="song gameControlElement" id="song_title_3.png" tabindex="-1"  data-sample-id="">
                <img class="song gameControlElement" id="song_title_4.png" tabindex="-1"  data-sample-id="">
                <img class="song gameControlElement" id="song_title_5.png" tabindex="-1"  data-sample-id="">
                <img class="song gameControlElement" id="song_title_6.png" tabindex="-1"  data-sample-id="">
                <img class="song gameControlElement" id="song_title_7.png" tabindex="-1"  data-sample-id="">
                <img class="song gameControlElement" id="song_title_8.png" tabindex="-1"  data-sample-id="">
                <img class="song gameControlElement" id="song_title_9.png" tabindex="-1"  data-sample-id="">
                <img class="song gameControlElement" id="song_title_10.png" tabindex="-1"  data-sample-id="">
            </div>

            <div id="vocalizer">
                    <div class="gameControlElement" data-sample-id=""></div>
                    <div class="gameControlElement" data-sample-id=""></div>
                    <div class="gameControlElement" data-sample-id=""></div>
                    <div class="gameControlElement" data-sample-id=""></div>
                    <div class="gameControlElement" data-sample-id=""></div>
                    <div class="gameControlElement" data-sample-id=""></div>
                    <div class="gameControlElement" data-sample-id=""></div>
                    <div class="gameControlElement" data-sample-id=""></div>
            </div>

            <div class="slider-wrapper" >
                <input class="gameControlElement" id="volume" tabindex="-1" type="range" min="0" max="11" value="7" step="1">
            </div>

            <div class="gameControlElement" id="vibe-trigger" tabindex="-1"></div>
            <select class="gameControlElement" id="vibe-select" tabindex="-1"></select>

            <div class="gameControlElement" id="bop-trigger" tabindex="-1"></div>
            <select class="gameControlElement" id="bop-select" tabindex="-1"></select>

            <select class="gameControlElement" id="pitchem-digit-select" tabindex="-1"></select>
            <select class="gameControlElement" id="pitchem-key-select" tabindex="-1"></select>

            <div class="gameControlElement" id="controls" tabindex="-1">
                <button id="start-stop"></button>
                <button id="clear"></button>
            </div>

            <button id="quit-menu" tabindex="-1"></button>

            <button id="keymap-trigger" tabindex="-1"></button>
            <img id="keymap-image" src="">

            <!-- <support id="support">This game remake is in the development stage, help me test RRR by submitting bugs!<a
                    href="mailto:%20jpelrah@wpi.edu?subject=RRR%20Bug%20Submission&amp;body=Briefly%20describe%20the%20bug.%20Also%20provide%20your%20operating%20system%28Win%2COSX%2CLinux...%29%20and%20the%20browser%28Chrome%2C%20Firefox...%29%20used%20to%20access%20the%20game.%0A%0AThank%20you%20for%20your%20contribution%21%20-%20Jake"
                    id="bug-link">Report Bug: Jpelrah@wpi.edu</a>
            </support> -->

        </div>
    </div>

    <script>

        let audioCtx = null
        let genres = null
        let currentGenre = null

        let samplesBuffer = []
        let songalizer = null
        let vocalizer = null
        let recorder = null

        async function init() {

            // initialize web audio
            audioCtx = window.AudioContext || window.webkitAudioContext
            if (audioCtx) {
                audioCtx = new audioCtx()
                audioCtx.onstatechange = (e) => console.log('Audio State: ' + e.target.state)
            } else {
                console.log('Web Audio Not Supported')
            }

            // fetch generes & cache to local storage
            try {
                if (!localStorage.getItem('genres')) {
                    console.log('Fetching available genres.')
                    const res = await fetch('/data')
                    const json = await res.json()
                    localStorage.setItem('genres', JSON.stringify(json))
                    genres = JSON.parse(localStorage.getItem('genres'))
                }
                // use cached genres
                else {
                    console.log('Using cached genres.')
                    genres = JSON.parse(localStorage.getItem('genres'))
                }
            }
            catch (e) {
                alert('Failed to load available genres, please submit a bug report.')
                genres = null
            }



            // create and display main menu
            const mainMenu = document.getElementById('main-menu')
            mainMenu.style.background = `url(../images/mainMenu.png) no-repeat`
            mainMenu.style.backgroundSize = '100% 100%'

            const genresDiv = document.createElement('div')
            genresDiv.setAttribute('id', 'genres')
            let colDiv
            const entriesPerCol = 5
            Object.keys(genres).forEach((genre, i) => {
                //create new column
                if (i % entriesPerCol === 0) {
                    colDiv = document.createElement('div')
                    colDiv.setAttribute('class', 'genre-column')
                    genresDiv.appendChild(colDiv)
                }
                const genreTitle = document.createElement('button')
                genreTitle.innerText = genre.match(/[A-Z][a-z]+/g).join(' ')

                // resume audio context if suspened, when we click on a genre.
                genreTitle.addEventListener('click', () => {
                    if (audioCtx.state === 'suspended') {
                        audioCtx.resume().then(function () {
                            console.log('Resuming audio context.')
                        });
                    }

                    currentGenre = genres[genre]

                    // hide main menu
                    mainMenu.style.display = 'none'
                    
                    // load samples then display new game
                    samplesBuffer = []
                    loadSamples(currentGenre.samples).then(audioBuffers => {

                        currentGenre.samples.forEach((sample, index) => {
                            const id = sample.split(new RegExp(/\.wav|\//))[4]
                            samplesBuffer.push({ id, audioBuffer: audioBuffers[index] })
                        })

                        const style = currentGenre.style

                        const gameBoard = document.getElementById('game-board')                        
                        gameBoard.style.background = `url(../genres/${style}/images/${style}.png) no-repeat`
                        gameBoard.style.backgroundSize = '100% 100%'
                        gameBoard.style.display = ''

                        // setup songalizer
                        const songalizerSampleDivs = document.getElementById('songs').querySelectorAll('div')
                        const songalizerTitleButtons = document.getElementById('song-names').querySelectorAll('img')
                        currentGenre.songalizer_samples.forEach((sample, i) => {
                            songalizerSampleDivs[i].setAttribute('data-sample-id', sample.id)
                            songalizerTitleButtons[i].setAttribute('data-sample-id', sample.id)
                            songalizerTitleButtons[i].src = `../genres/${style}/images/song_title_${i + 1}.png`
                        })

                        songalizerTitleButtons.forEach((songImg, i) => {
                            this.isPlaying = false
                            this.previewSample = null
                            songImg.onclick = () => {

                                if (!songalizer.isPlaying) {
                                    this.isPlaying = !this.isPlaying
                                    if (this.isPlaying) {
                                        const id = songImg.getAttribute('data-sample-id')
                                        this.previewSample = playSampleById({ id })
                                        songImg.src = `../genres/${style}/images/asong_title_${i + 1}.png`
                                    }
                                    else {
                                        this.previewSample.stop()
                                        songImg.src = `../genres/${style}/images/song_title_${i + 1}.png`
                                    }

                                    songImg.onblur = () => {
                                        this.isPlaying = false
                                        this.previewSample.stop()
                                        songImg.src= `../genres/${style}/images/song_title_${i + 1}.png`
                                    }

                                }

                            }
                        })
                        songalizer = new Songalizer()


                        // setup vocalizer
                        const vocalizerDivs = document.getElementById('vocalizer').querySelectorAll('div')
                        currentGenre.vocalizer_samples.forEach((sample, i) => {
                            vocalizerDivs[i].setAttribute('data-sample-id', sample.id)
                        })
                        vocalizer = new Vocalizer()


                        // setup vibe & bop
                        const vibeSelect = document.getElementById('vibe-select')
                        const vibeTrigger = document.getElementById('vibe-trigger')
                        const bopSelect = document.getElementById('bop-select')
                        const bopTrigger = document.getElementById('bop-trigger')
                        currentGenre.vibeBop.forEach(sample => {
                            const vOption = document.createElement('option')
                            const bOption = document.createElement('option')
                            vOption.value = sample.id
                            bOption.value = sample.id
                            vOption.innerText = sample.title
                            bOption.innerText = sample.title
                            vibeSelect.appendChild(vOption)
                            bopSelect.appendChild(bOption)
                        })
                        vibeTrigger.onclick = () => {
                            vibeTrigger.style.background = `url(../genres/${style}/images/vibe.png) no-repeat`
                            vibeTrigger.style.backgroundSize = '100% 100%'
                            const src = this.playSampleById({ id: vibeSelect.value })
                            src.onended = () => {
                                vibeTrigger.style.background = ''
                            }

                        }
                        bopTrigger.onclick = () => {
                            bopTrigger.style.background = `url(../genres/${style}/images/bop.png) no-repeat`
                            bopTrigger.style.backgroundSize = '100% 100%'
                            const src = this.playSampleById({ id: bopSelect.value })
                            src.onended = () => {
                                bopTrigger.style.background = ''
                            }
                        }


                        // setup pitchem
                        const pitchemDigitSelect = document.getElementById('pitchem-digit-select')
                        currentGenre.pitchem.digits.forEach(sample => {
                            const option = document.createElement('option')
                            option.value = sample.id
                            option.innerText = sample.title
                            pitchemDigitSelect.appendChild(option)
                        })
                        const pitchemKeySelect = document.getElementById('pitchem-key-select')
                        currentGenre.pitchem.keys.forEach(sample => {
                            const option = document.createElement('option')
                            option.value = sample.id
                            option.innerText = sample.title
                            pitchemKeySelect.appendChild(option)
                        })


                        // setup key map overlay
                        const keyImage = document.getElementById('keymap-image')
                        keyImage.src = `../genres/${style}/images/keymap.png`
                        keyImage.style.display = 'none'
                        keyImage.onclick = () => {
                            keyImage.style.display = 'none'
                        }
                        const keyTrigger = document.getElementById('keymap-trigger')
                        keyTrigger.onclick = () => {
                            keyImage.style.display = ''
                        }
                        document.onkeydown = (e) => {
                            if (!e.repeat) {

                                // is it a digit
                                const digitMap = currentGenre.pitchem.numMap
                                Object.entries(digitMap).forEach((entry) => {
                                    const code = e.code
                                    if (entry[0] === code) {
                                        playSampleById({ id: pitchemDigitSelect.value, detuneAmt: digitMap[code] })
                                    }
                                })

                                // or is it in the top row?
                                const peKeyMap = currentGenre.pitchem.keyMap
                                console.log(peKeyMap)
                                Object.entries(peKeyMap).forEach((entry) => {
                                    const code = e.code
                                    if (entry[0] === code) {
                                        playSampleById({ id: pitchemKeySelect.value, detuneAmt: peKeyMap[code] })
                                    }
                                })

                                const keyMap = currentGenre.keyMap
                                currentGenre.keyMap.forEach((sample) => {
                                    if (sample.key === e.code) {
                                        this.playSampleById({ id: sample.id })
                                    }
                                })

                            }
                        }

                        // setup navigation
                        const quitMeuButton = document.getElementById('quit-menu')
                        quitMeuButton.onclick = () => {

                            if (songalizer.isPlaying) {
                                songalizer.stopSongalizer()
                            }
                            // reset board
                            vibeSelect.innerHTML = ''
                            bopSelect.innerHTML = ''
                            startStop.style.background = ''
                            pitchemDigitSelect.innerHTML = ''
                            pitchemKeySelect.innerHTML = ''
                            document.getElementById('slots').innerHTML = ''
                            gameBoard.style.display ='none'
                            mainMenu.style.display = ''
                        }


                        //setup controls
                        const [startStop, clear] = document.getElementById('controls').querySelectorAll('button')
                        startStop.onclick = () => {
                            console.log(songalizer)
                            if (!songalizer.isPlaying && songalizer.tracks.length > 0) {
                                songalizer.toggle()
                                startStop.style.background = `url("../genres/${style}/images/stop.png") no-repeat`
                                startStop.style.backgroundSize = '100% 100%'
                            }
                            else if (songalizer.isPlaying) {
                                songalizer.stopSongalizer()
                                startStop.style.background = ''
                            }
                        }
                        clear.onclick = () => {
                            songalizer.clearSongalizer()
                            startStop.style.background = ''
                        }

                    })
                })
                colDiv.appendChild(genreTitle)
            })
            mainMenu.appendChild(genresDiv)
        }


        async function loadSamples(samples) {
            const promises = []
            for (const path of samples) {
                const res = await fetch(path)
                const arrayBuffer = await res.arrayBuffer()
                const audioBuffer = audioCtx.decodeAudioData(arrayBuffer)
                promises.push(audioBuffer)
            }
            return Promise.all(promises)
        }


        function playSampleById({ id, start = 0, detuneAmt = 0 }) {
            console.log(id, start, detuneAmt)
            const src = audioCtx.createBufferSource()
            src.buffer = samplesBuffer.find(x => x.id === id).audioBuffer
            src.detune.value = detuneAmt
            src.connect(audioCtx.destination)
            // src.connect(recorder.dest)
            src.start(start)
            return src
        }


        window.onload = init()


        class Vocalizer {
            constructor() {
                this.isPlaying = false
                this.triggers = document.querySelector('#vocalizer').querySelectorAll('div')
                this.triggers.forEach(trigger => trigger.addEventListener('click', () => this.onClick(trigger)))
                this.start = 0
                this.prevDuration = 0
                this.counter = 0
            }

            onClick(trigger) {
                trigger.disabled = true
                trigger.style.opacity = .5
                trigger.style.backgroundColor = 'white'
                trigger.style.filter = 'blur(4px)'
                const id = trigger.getAttribute('data-sample-id')
                const source = audioCtx.createBufferSource()
                source.buffer = samplesBuffer.find(x => x.id === id).audioBuffer
                source.connect(audioCtx.destination)
                // source.connect(this.recorder.dest)

                if (!this.isPlaying) {
                    this.start = audioCtx.currentTime
                    source.start(this.start)
                    this.counter++
                }
                else if (this.isPlaying) {
                    source.start(this.start + this.prevDuration)
                    this.counter++
                }
                source.onended = () => {
                    trigger.disabled = false
                    trigger.style.opacity = 0
                    this.counter--
                    console.log('Audio counter', this.counter)
                    if (this.counter === 0) {
                        console.log('DONE')
                        this.isPlaying = false
                        this.start = 0
                        this.prevDuration = 0
                        this.counter = 0
                    }
                }
                this.isPlaying = true
                this.prevDuration += source.buffer.duration

            }
        }


        class Songalizer {
            constructor() {
                this.scheduleAheadTime = .1
                this.nextTrackTime = 0.0;
                this.lookahead = 25.0;
                this.timerWorker = null;

                this.isPlaying = false
                this.currentTrackIndex = 0
                this.currentSource = null
                this.selectedSong = null

                this.tracks = []
                this.counter = 0

                this.songs = document.getElementById('songs').querySelectorAll('div')
                this.slots = document.getElementById('slots')


                this.songs.forEach(song => {

                    song.onmousedown = (ev) => {
                        console.log('jhere')
                        this.selectedSong = song
                        document.body.style.cursor = 'url(../images/outline.png) 20 20, pointer'
                        //disable pointer events on gameInputElements
                        document.querySelectorAll('.gameControlElement').forEach(elem => elem.style.pointerEvents = 'none')
                    }

                    document.onmouseup = () => {
                        if (this.isPlaying) {

                            document.querySelectorAll('.gameControlElement').forEach(elem => {
                                if (elem.classList.contains('song')) {
                                    elem.style.pointerEvents = 'auto'
                                }
                            })
                        }
                        else {
                            document.querySelectorAll('.gameControlElement').forEach(elem => elem.style.pointerEvents = 'auto')
                        }
                        document.body.style.cursor = 'auto'
                        this.selectedSong = null
                    }
                })

                this.slots.onmouseup = () => {

                    const MAX_SONGS = 10
                    if (!this.isPlaying && this.tracks.length < MAX_SONGS) {
                        const id = this.selectedSong.getAttribute('data-sample-id')
                        const imgElem = document.createElement('img')
                        imgElem.setAttribute('id', this.selectedSong.id)
                        imgElem.setAttribute('draggable', false)
                        imgElem.setAttribute('data-sample-id', id)
                        imgElem.setAttribute('src', `../genres/${currentGenre.style}/images/${this.selectedSong.id}.png`)
                        this.slots.appendChild(imgElem)
                        const { audioBuffer } = samplesBuffer.find(x => x.id === id)
                        this.tracks.push({ id, audioBuffer })

                        //enable pointer events on gameInputElements
                        document.querySelectorAll('.gameControlElement').forEach(elem => elem.style.pointerEvents = 'auto')
                        document.body.style.cursor = 'auto'
                        this.selectedSong = null
                    }
                }

                // setup web worker
                this.timerWorker = new Worker('js/songalizerworker.js');
                this.timerWorker.onmessage = (e) => {
                    if (e.data === 'tick') {
                        this.scheduler()
                    }
                    else {
                        console.log('message:' + e.data)
                    }
                }
                this.timerWorker.postMessage({ 'interval': this.lookahead })
            }

            stopSongalizer() {

                if (this.currentSource) {
                    this.currentSource.stop()
                }
                this.isPlaying = false
                this.counter = 0
                this.currentSource = null
                this.timerWorker.postMessage('stop')
                // disable dragging of songs
                document.getElementById('songs')
                    .querySelectorAll('.gameControlElement')
                    .forEach(elem => elem.style.pointerEvents = 'auto')
                //reset slot state images here
                this.slots.querySelectorAll('img').forEach(img => {
                    img.src = `../genres/${currentGenre.style}/images/song_${img.src.split('_')[1]}`
                })
            }

            toggle() {

                if (this.tracks.length !== 0) {

                    this.isPlaying = !this.isPlaying

                    if (this.isPlaying) {

                        // disable dragging of songs
                        document.getElementById('songs')
                            .querySelectorAll('.gameControlElement')
                            .forEach(elem => elem.style.pointerEvents = 'none')

                        this.timerWorker.postMessage('start')
                        this.nextTrackTime = audioCtx.currentTime
                    }
                    else {
                        this.stopSongalizer()
                    }
                }
                else {
                    console.log('Songalizer has no tracks to play!')
                }

            }

            scheduleTrack(id, start) {
                this.currentSource = playSampleById({ id, start })

            }

            scheduler() {

                while (this.nextTrackTime < audioCtx.currentTime + this.scheduleAheadTime) {

                    this.currentTrackIndex = this.counter % this.tracks.length
                    const { id } = this.tracks[this.currentTrackIndex]
                    this.scheduleTrack(id, this.nextTrackTime)
                    this.displayCurrentSong()

                    //add duration of next track to nextTrackTime
                    const { audioBuffer: { duration } } = this.tracks[this.currentTrackIndex]
                    this.nextTrackTime += duration
                    this.counter++
                }
            }


            clearSongalizer() {
                if (this.isPlaying) {
                    this.isPlaying = !this.isPlaying
                    this.stopSongalizer()
                }
                this.tracks = []
                this.slots.innerHTML = ''
            }

            displayCurrentSong() {

                const songs = this.slots.querySelectorAll('img')
                const style = currentGenre.style

                if (this.tracks.length > 1) {
                    const currentSong = songs[this.currentTrackIndex]
                    const id = currentSong.getAttribute('id')

                    currentSong.src = `../genres/${style}/images/a${id}.png`

                    const prevSongIndex = this.currentTrackIndex - 1 < 0 ? this.tracks.length - 1 : this.currentTrackIndex - 1
                    const prevSong = songs[prevSongIndex]
                    prevSong.src = `../genres/${style}/images/song_${prevSong.id.split('_')[1]}.png`
                }

                else if (this.tracks.length === 1) {
                    const currentSong = songs[this.currentTrackIndex]
                    const id = currentSong.getAttribute('id')
                    console.log(style, id)
                    currentSong.src = `../genres/${style}/images/a${id}.png`
                }
            }
        }


         class Recorder {
            constructor() {
                this.chunks = []
                this.dest = audioCtx.createMediaStreamDestination()
                this.mediaRecorder = new MediaRecorder(this.dest.stream, { mimeType: 'audio/webm' })

                this.mediaRecorder.ondataavailable = (evt) => {
                    // push each chunk (blobs) in an array
                    this.chunks.push(evt.data);
                };

                this.mediaRecorder.onstop = (evt) => {
                    // Make blob out of our blobs, and open it.
                    const blob = new Blob(this.chunks, { 'type': 'audio/webm; codecs=0' });
                    document.querySelector("audio").src = URL.createObjectURL(blob);
                };
            }

            start() {
                console.log('starting')
                this.mediaRecorder.start()
            }

            stop() {
                console.log('stoping')
                this.mediaRecorder.stop()
            }
        }


        //         // recording
        //         // const recordDiv = document.createElement('div')
        //         // recordDiv.setAttribute('id', 'recording')

        //         // // const audioElem = document.createElement('audio')
        //         // // audioElem.setAttribute('controls', true)
        //         // // recordDiv.appendChild(audioElem)

        //         // const record = document.createElement('button')
        //         // record.innerText = 'RECORD'
        //         // record.addEventListener('click', () => recorder.start())
        //         // recordDiv.appendChild(record)


        //         // const stop = document.createElement('button')
        //         // stop.innerText = 'STOP'
        //         // stop.addEventListener('click', () => recorder.stop())
        //         // recordDiv.appendChild(stop)

        //         // gameWrapper.appendChild(recordDiv)

    </script>


</body>

</html>